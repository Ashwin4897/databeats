{% extends "base.html" %}
{% block content %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3"></script>
    <script>
        $DATABASE_GET_MEASUREMENTS_URL = '{{ url_for('database_bp.get_measurements') }}';
        $DATABASE_GET_FIELDS_URL = '{{ url_for('database_bp.get_fields') }}';
        $DATABASE_GET_TAG_NAMES_URL = '{{ url_for('database_bp.get_tag_names') }}';
        $DATABASE_GET_TAG_VALUES_URL = '{{ url_for('database_bp.get_tag_values') }}';
    </script>
    <script src="{{ url_for('sonify_bp.static', filename='sonify.js') }}"></script>
    <style>
        #resultsChart {
            border: solid 1px black;
            width: 100%;
        }

        audio {
            width: 100%;
        }
    </style>
    <main role="main" class="flex-shrink-0">
        <div class="container-fluid">
            <div class="jumbotron text-center">
                <h1>Sonify</h1>
                <p class="lead">Create a query to return time series data to be sonified.</p>
            </div>

            <h1 class="mt-5">From a session ID</h1>
            <p class="lead">Lookup a previous query using your session ID.</p>
            <form action="#" method="post">
                <div class="row mb-3">
                    <div class="col-md-4 mb-3">
                        <input type="text" class="form-control" name="sessionID" placeholder="Session ID" value=""
                               required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button type="submit" class="btn btn-success" name="action" value="lookup">Lookup</button>
                    </div>
                </div>
            </form>

            <h1 class="mt-5">From a query</h1>
            <form action="#" method="post">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="database">Database</label>
                        <select class="custom-select" id="database" name="database" required>
                            <option selected disabled hidden></option>
                            {% for db in list_dbs %}
                                {% if db != 'telegraf' and db != '_internal' %}
                                    <option>{{ db }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="measurement">Measurement</label>
                        <select class="custom-select" id="measurement" name="measurement" required disabled>
                            <option>Select a database...</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="field">Field</label>
                        <select class="custom-select" id="field" name="field" required disabled>
                            <option>Select a measurement...</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="tagName">Tag name (Optional)</label>
                        <select class="custom-select" id="tagName" name="tagName" disabled>
                            <option>Select a measurement...</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="tagValue">Tag value (Optional)</label>
                        <select class="custom-select" id="tagValue" name="tagValue" disabled>
                            <option>Select a tag name...</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="datetimeStart">Start datetime</label>
                        <input class="form-control" type="datetime-local" value="{{ datetimeS }}" id="datetimeStart"
                               name="datetimeStart" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="datetimeEnd">End datetime</label>
                        <input class="form-control" type="datetime-local" value="{{ datetimeE }}" id="datetimeEnd"
                               name="datetimeEnd" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <button type="submit" class="btn btn-success" name="action" value="query">Run query</button>
                    </div>
                </div>
            </form>
            {% if music %}
                <h1 class="mt-5">Results</h1>
                <p class="lead">This session ID will allow you to pull up your results in the future.</p>
                <p class="lead">Session ID: <code>{{ sessionID }}</code></p>
                <a href="http://localhost:8888/sources/10000/chronograf/data-explorer?query={{ query }}">View on
                    Chronograf</a>
                <canvas id="resultsChart" height="700"></canvas>
                <script>createChart({{ labels|tojson }}, {{ values|tojson }}, '{{ legend|safe }}');</script>
                <audio id="music" src="{{ musicPath }}" controls='controls'></audio>
                <script>startListeners({{ amountPoints|safe }})</script>
            {% endif %}
        </div>
    </main>
{% endblock %}